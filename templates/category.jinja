{% extends "layout.jinja" %}

{% block header %}
	{% include 'header.jinja' %}
{% endblock %}

{% block top_links %}
	<link rel="stylesheet" type="text/css" href="{{ 'toastr.min.css' | asset_url }}" />
{% endblock %}

{% block main_content %}

<div class="breadcrumb-subtitle">
{# {% set img = category.image %}
{% set title = category.name %}
{% set description = category.description %}
	{% include 'components/breadcrumb-subTitle-detail.jinja' %} #}
	<section class="breadcrumb-section">
		<nav aria-label="breadcrumb">
				<div class="container">
			    <ol class="breadcrumb">
					<li class="breadcrumb-item" aria-current="page">
						<a href="/">{{ _("Home") }}</a>
					</li>
					{% if category.parent_category.parent_category %}
						<li class="breadcrumb-item" aria-current="page">
							<a href="{{ category.parent_category.parent_category.url }}">{{ category.parent_category.parent_category.name }}</a>
						</li>
					{% endif %}

					{% if category.parent_category %}
						<li class="breadcrumb-item" aria-current="page">
							<a href="{{ category.parent_category.url }}">{{ category.parent_category.name }}</a>
						</li>
					{% endif %}
					<li class="breadcrumb-item active " aria-current="page">{{ category.name }}</li>
			    </ol>
				</div>
		</nav>
	</section>
</div>

  {# عرض البانرات المخصصة للتصنيف #}
  {% set category_banners = [] %}
  {% if 'categories_page_category_banners' in settings %}
    {% set banners_list = settings.categories_page_category_banners %}
    {% if banners_list is callable %}
      {% set banners_list = banners_list() %}
    {% endif %}
    {% if banners_list is iterable %}
      {% for banner_item in banners_list %}
        {% set banner_category_id = banner_item.category_id %}
        {% if banner_category_id is mapping %}
          {% set banner_category_id = banner_category_id.id %}
        {% endif %}
        {% if banner_category_id|string == category.id|string %}
          {% set _ = category_banners.append(banner_item) %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
  
  {# إذا كان هناك بانرات مخصصة، اعرضها في سلايدر Swiper #}
  {% if category_banners | length > 0 %}
    <div class="container">
      <div class="category-banners-swiper swiper">
        <div class="swiper-wrapper">
          {% for banner_item in category_banners %}
            <div class="swiper-slide">
              <div class="category-banner-item">
                {% if banner_item.banner_url %}
                  <a href="{{ banner_item.banner_url }}" aria-label="Banner">
                {% endif %}
                {% if banner_item.banner_image or banner_item.banner_image_mobile %}
                  <picture>
                    {% if banner_item.banner_image_mobile %}
                      <source media="(max-width: 767px)" srcset="{{ image_url(banner_item.banner_image_mobile) }}">
                    {% endif %}
                    {% if banner_item.banner_image %}
                      <source media="(min-width: 768px)" srcset="{{ image_url(banner_item.banner_image) }}">
                      <img 
                        loading="lazy" 
                        class="category-cover-img" 
                        src="{{ image_url(banner_item.banner_image) }}" 
                        alt="Category Banner"
                      >
                    {% elif banner_item.banner_image_mobile %}
                      <img 
                        loading="lazy" 
                        class="category-cover-img" 
                        src="{{ image_url(banner_item.banner_image_mobile) }}" 
                        alt="Category Banner"
                      >
                    {% endif %}
                  </picture>
                {% endif %}
                {% if banner_item.banner_url %}
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
        {# Pagination #}
        <div class="swiper-pagination"></div>
        {# Navigation arrows #}
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
      </div>
    </div>
    
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var categoryBannersSwiper = new Swiper('.category-banners-swiper', {
          slidesPerView: 1,
          spaceBetween: 0,
          loop: {{ 'true' if category_banners | length > 1 else 'false' }},
          autoplay: {
            delay: 5000,
            disableOnInteraction: false,
          },
          pagination: {
            el: '.category-banners-swiper .swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.category-banners-swiper .swiper-button-next',
            prevEl: '.category-banners-swiper .swiper-button-prev',
          },
          {% if category_banners | length == 1 %}
          // إخفاء الأسهم والـ pagination إذا كان هناك بانر واحد فقط
          on: {
            init: function() {
              this.navigation.nextEl.style.display = 'none';
              this.navigation.prevEl.style.display = 'none';
              this.pagination.el.style.display = 'none';
            }
          }
          {% endif %}
        });
      });
    </script>
  {% endif %}

  {# عرض منتجات بتبويبات للتصنيف #}
  {% set category_tabs_products = [] %}
  {% if 'categories_page_category_tabs_products' in settings %}
    {% set tabs_products_list = settings.categories_page_category_tabs_products %}
    {% if tabs_products_list is callable %}
      {% set tabs_products_list = tabs_products_list() %}
    {% endif %}
    {% if tabs_products_list is iterable %}
      {% for tabs_item in tabs_products_list %}
        {% set tabs_category_id = tabs_item.category_id %}
        {% if tabs_category_id is mapping %}
          {% set tabs_category_id = tabs_category_id.id %}
        {% endif %}
        {% if tabs_category_id|string == category.id|string %}
          {% set _ = category_tabs_products.append(tabs_item) %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
  
  {# عرض منتجات بتبويبات #}
  {% if category_tabs_products | length > 0 %}
    {% for tabs_item in category_tabs_products %}
      {% set sectionId = 'category-tabs-' ~ category.id ~ '-' ~ loop.index %}
      {% set settings = tabs_item %}
      {% include 'sections/tabs-products.jinja' %}
    {% endfor %}
  {% else %}
  {% endif %}

  {# عرض بانرات للتصنيف #}
  {% set category_banners_sections = [] %}
  {% if 'categories_page_category_banners_sections' in settings %}
    {% set banners_sections_list = settings.categories_page_category_banners_sections %}
    {% if banners_sections_list is callable %}
      {% set banners_sections_list = banners_sections_list() %}
    {% endif %}
    {% if banners_sections_list is iterable %}
      {% for banners_item in banners_sections_list %}
        {% set banners_category_id = banners_item.category_id %}
        {% if banners_category_id is mapping %}
          {% set banners_category_id = banners_category_id.id %}
        {% endif %}
        {% if banners_category_id|string == category.id|string %}
          {% set _ = category_banners_sections.append(banners_item) %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
  
  {# عرض بانرات #}
  {% if category_banners_sections | length > 0 %}
    {% for banners_item in category_banners_sections %}
      {% set sectionId = 'category-banners-' ~ category.id ~ '-' ~ loop.index %}
      {% set settings = banners_item %}
      {% include 'sections/banners.jinja' %}
    {% endfor %}
  {% endif %}

  {# عرض فيديو ومنتجات للتصنيف #}
  {% set category_video_with_products = [] %}
  {% if 'categories_page_category_video_with_products' in settings %}
    {% set video_products_list = settings.categories_page_category_video_with_products %}
    {% if video_products_list is callable %}
      {% set video_products_list = video_products_list() %}
    {% endif %}
    {% if video_products_list is iterable %}
      {% for video_item in video_products_list %}
        {% set video_category_id = video_item.category_id %}
        {% if video_category_id is mapping %}
          {% set video_category_id = video_category_id.id %}
        {% endif %}
        {% if video_category_id|string == category.id|string %}
          {% set _ = category_video_with_products.append(video_item) %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
  
  {# عرض فيديو ومنتجات #}
  {% if category_video_with_products | length > 0 %}
    {% for video_item in category_video_with_products %}
      {% set sectionId = 'category-video-' ~ category.id ~ '-' ~ loop.index %}
      {% set settings = video_item %}
      {% include 'sections/video-with-products.jinja' %}
    {% endfor %}
  {% else %}
  {% endif %}

{# البحث عن الإعدادات المطابقة للتصنيف الحالي - بدون JavaScript #}
{% set hide_sub_categories_names = false %}
{% set fixed_categories = false %}

{% if 'categories_page_category_settings' in settings %}
  {% set category_settings_list = settings.categories_page_category_settings %}
  {% if category_settings_list is callable %}
    {% set category_settings_list = category_settings_list() %}
  {% endif %}
  {% if category_settings_list is iterable %}
    {# استخدام loop variables للبحث عن العنصر المطابق #}
    {% set matched_setting = [] %}
    {% for setting_item in category_settings_list %}
      {% if setting_item and setting_item.category_id %}
        {% set setting_category_id = setting_item.category_id %}
        {% if setting_category_id is mapping %}
          {% set setting_category_id = setting_category_id.id %}
        {% endif %}
        {% if setting_category_id|string == category.id|string %}
          {# استخدام list append بدلاً من set مباشر #}
          {% if loop.first or matched_setting|length == 0 %}
            {% set _ = matched_setting.append(setting_item) %}
          {% endif %}
          {% break %}
        {% endif %}
      {% endif %}
    {% endfor %}
    
    {# استخراج القيم من matched_setting #}
    {% if matched_setting|length > 0 %}
      {% set matched_setting = matched_setting[0] %}
      {% if matched_setting.hide_sub_categories_names %}
        {% set hide_sub_categories_names = true %}
      {% endif %}
      {% if matched_setting.fixed_categories %}
        {% set fixed_categories = true %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endif %}

{# ================================
   Sub Categories Section
================================ #}
{% if category.sub_categories | length > 0 %}
<div class="container">
  <div class="home-categories-section {% if fixed_categories %}fixed-categories{% endif %}">

    <div class="tp-category-swiper swiper-container">
      <div class="swiper-wrapper">

        {% for categoryItem in category.sub_categories %}
          <div class="swiper-slide">
            <div class="tp-product-category-item">

              {% if categoryItem.image %}
              <div class="tp-product-category-thumb fix">
                <a href="/categories/{{ categoryItem.id }}/{{ categoryItem.slug }}">
                  <img
                    loading="lazy"
                    src="{{ image_url(categoryItem.image, { w: 235, q: 100, f: 'auto' }) }}"
                    alt="{{ categoryItem.name }}"
                  >
                </a>
              </div>
              {% endif %}

              {% if not hide_sub_categories_names %}
              <div class="tp-product-category-content">
                <h2 class="tp-product-category-title">
                  <a href="/categories/{{ categoryItem.id }}/{{ categoryItem.slug }}">
                    {{ categoryItem.name }}
                  </a>
                </h2>
              </div>
              {% endif %}

            </div>
          </div>
        {% endfor %}

      </div>
    </div>

  </div>

  {# ================================
     Swiper Init
  ================================ #}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const fixedMode = {{ 'true' if fixed_categories else 'false' }};

      if (!fixedMode) {
        new Swiper(".tp-category-swiper", {
          slidesPerView: "auto",
          spaceBetween: 16,
          freeMode: true,
          autoplay: {
            delay: 3000,
          },
          navigation: {
            nextEl: ".tp-slider-button-next",
            prevEl: ".tp-slider-button-prev",
          },
          breakpoints: {
            0: {
              slidesPerView: "auto",
              spaceBetween: 10,
            },
            768: {
              slidesPerView: "auto",
              spaceBetween: 16,
            },
          },
        });
      }
    });
  </script>
</div>
{% endif %}

     <div class="container">
        <div class="products-filters-box">
            {% if  products.filters|length > 0 %}
              {% set async=true %} {% include 'vitrin:products/filters.jinja' %}
            {% endif %}
            <div class="products-container">
              <div>
                {% set count=products.count %}{% set has_products_filtration=(products.filters|length > 0) %}{% include 'components/products-filter.jinja' %}
            </div>
              <div id="products-list" class="products-grid">
                {% for product in products.results %}
                  {% set product=product %}{% set index=key %}{% include 'components/product-card.jinja' %}
                {% endfor %}
              </div>
            </div>
          </div>
    </div>


    {% set totalPages=products.pages_count %}{% set currentPage=products.page %}{% include 'components/pagination.jinja' %}

	<div class="container">
		{% set entity = category %}
    {% include 'vitrin:shared/metafields.jinja' %}
	</div>

{% endblock %}

{% block footer %}
	{% include 'footer.jinja' %}
{% endblock %}


{% block footer_scripts %}
<script type="text/javascript" src="{{ 'toastr.min.js' | asset_url }}"></script>
	<script>
		window.onProductAttributesTriggered = function () {
$('#products-list').css('opacity', '0.4');
$('#product-pagination').css('opacity', '0');

}

window.onProductAttributesChanged = function (htmlStr) {
var html = $.parseHTML(htmlStr);
$('#products-list').html($('#products-list', html).html());
$('#products-list').css('opacity', '1');
$('#product-filter-count').html($('#product-filter-count', html).html());
$('#product-filter-count').css('opacity', '1');
if ($('#product-pagination', html).length > 0) {
$('#product-pagination').html($('#product-pagination', html).html());
$('#product-pagination').css('opacity', '1');
}
}

{% if  products.data|length > 0 %}
        document.addEventListener("DOMContentLoaded", function(){
            var productsObj = {{ products.data | tojson }}
                window.sendGaProductsViewItemsListEvent('{{ category.name }}', productsObj);
        });
        {% endif %}
	</script>

<script>
window.addEventListener('DOMContentLoaded', (event) => {
    var fromPriceInput = document.querySelector("input[name='from_price'][type='hidden']");
    var toPriceInput = document.querySelector("input[name='to_price'][type='hidden']");

    if (fromPriceInput && toPriceInput) {
        var fromPrice = fromPriceInput.value;
        var toPrice = toPriceInput.value;

        var fromPriceField = document.querySelector(".attribute-price-body input[name='from_price']");
        var toPriceField = document.querySelector(".attribute-price-body input[name='to_price']");

        if (fromPriceField && toPriceField) {
            fromPriceField.value = fromPrice;
            toPriceField.value = toPrice;
        }
    }
});

function loadNoUiSlider(callback) {
    let link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css";
    document.head.appendChild(link);

    let script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js";
    script.onload = callback;
    document.body.appendChild(script);
}

loadNoUiSlider(() => {
    const priceContainer = document.querySelector(".attribute-price-body .form-row");

    if (!priceContainer) {
        return;
    }

    const sliderContainer = document.createElement("div");
    sliderContainer.id = "price-slider";

    priceContainer.insertAdjacentElement("afterend", sliderContainer);

    noUiSlider.create(sliderContainer, {
        start: [0, 15000],
        connect: true,
        direction: "{{ session.locale.language.direction }}",
        range: {
            min: 0,
            max: 15000,
        },
        step: 10,
    });

    const fromPriceInput = document.querySelector('.attribute-price-body input[name="from_price"]');
    const toPriceInput = document.querySelector('.attribute-price-body input[name="to_price"]');

    if (!fromPriceInput || !toPriceInput) {
        return;
    }

    sliderContainer.noUiSlider.on("update", (values) => {
        fromPriceInput.value = Math.round(values[0]);
        toPriceInput.value = Math.round(values[1]);
    });

    fromPriceInput.addEventListener("change", () => {
        const fromValue = parseFloat(fromPriceInput.value) || 0;
        const toValue = parseFloat(toPriceInput.value) || 5000;

        sliderContainer.noUiSlider.set([fromValue, toValue]);
    });

    toPriceInput.addEventListener("change", () => {
        const fromValue = parseFloat(fromPriceInput.value) || 0;
        const toValue = parseFloat(toPriceInput.value) || 5000;

        sliderContainer.noUiSlider.set([fromValue, toValue]);
    });
});

const attributeFooter = document.querySelector('.attribute-footer');

if (attributeFooter) {
    const clearText = '{{ _("Clear") }}';

    attributeFooter.insertAdjacentHTML(
        'beforeend',
        `<button id="products-list-filter-form-clear" type="button" class="tp-btn tp-btn-primary-outline" onclick="clearFilters()">
            <span>${clearText}</span>
        </button>`
    );
}

const filterButton = document.querySelector('.open-close-filter');
const productAttributes = document.querySelector('.product-attributes');
const overlayFilter = document.querySelector('.overlay-filter');
const filtrationHeader = document.querySelector('.filtration-header');

filterButton.addEventListener('click', () => {
    productAttributes.classList.toggle('hide-filter');

    if (window.innerWidth <= 1200) {
        overlayFilter.classList.toggle('active');

        if (filtrationHeader) {
            if (!filtrationHeader.querySelector('em')) {
                const emElement = document.createElement('em');
                filtrationHeader.appendChild(emElement);
                 emElement.addEventListener('click', () => {
                    productAttributes.classList.remove('hide-filter');
                    overlayFilter.classList.remove('active');
                });
            }
        }
    }
});

overlayFilter.addEventListener('click', () => {
    productAttributes.classList.remove('hide-filter');
    overlayFilter.classList.remove('active');
});

</script>


{% endblock %}


