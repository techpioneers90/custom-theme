{% extends "layout.jinja" %}

{% block header %}
	{% include 'header.jinja' %}
{% endblock %}

{% block top_links %}
	<link rel="stylesheet" type="text/css" href="{{ 'toastr.min.css' | asset_url }}" />
{% endblock %}

{% block main_content %}
  {% if category.cover_image %}
  <div class="container">
    <img loading="lazy" class="category-cover-img" src="{{ image_url(category.cover_image) }}" alt="cover_image"></img>
  </div>
  {% endif %}


<div class="breadcrumb-subtitle">
{% set img = category.image %}
{% set title = category.name %}
{% set description = category.description %}
	{% include 'components/breadcrumb-subTitle-detail.jinja' %}
	<section class="breadcrumb-section">
		<nav aria-label="breadcrumb">
				<div class="container">
			    <ol class="breadcrumb">
					<li class="breadcrumb-item" aria-current="page">
						<a href="/">{{ _("Home") }}</a>
					</li>
					{% if category.parent_category.parent_category %}
						<li class="breadcrumb-item" aria-current="page">
							<a href="{{ category.parent_category.parent_category.url }}">{{ category.parent_category.parent_category.name }}</a>
						</li>
					{% endif %}

					{% if category.parent_category %}
						<li class="breadcrumb-item" aria-current="page">
							<a href="{{ category.parent_category.url }}">{{ category.parent_category.name }}</a>
						</li>
					{% endif %}
					<li class="breadcrumb-item active " aria-current="page">{{ category.name }}</li>
			    </ol>
				</div>
		</nav>
	</section>
</div>

	{% if category.sub_categories | length > 0 %}
		<div class="container">
			<div class="home-categories-section {% if fixed_on_mobile %}fixed-mobile{% endif %}">
        <div class="tp-category-swiper swiper-container">
        <div class="swiper-wrapper">
            {% for categoryItem in category.sub_categories %}
              <div class="swiper-slide">
                <div class="tp-product-category-item">
                {% if categoryItem.image %}
                  <div class="tp-product-category-thumb fix">
                    <a href="/categories/{{ categoryItem.id }}/{{ categoryItem.slug }}">
                      <img loading="lazy" src="{{ image_url(categoryItem.image, { w: 235, q: 100, f:'auto' }) }}" alt="{{ categoryItem.name }}">
                    </a>
                  </div>
                  {% endif %} 
                  <div class="tp-product-category-content">
                    <h2 class="tp-product-category-title">
                      <a href="/categories/{{ categoryItem.id }}/{{ categoryItem.slug }}">{{ categoryItem.name }}</a>
                    </h2>
                  </div>
                </div>
              </div>
            {% endfor %}
        </div>
        </div> 
			</div>
      <script>
          document.addEventListener("DOMContentLoaded", function () {
          const isMobile = window.innerWidth <= 768;
          const fixedMode = {{ 'true' if fixed_on_mobile else 'false' }};
          if (!(isMobile && fixedMode)) {
            var catgSlider = new Swiper(".tp-category-swiper", {
              slidesPerView: "auto",
              spaceBetween: 16,
              freeMode: true,
              autoplay: {
                delay: 3000,
              },
              navigation: {
                nextEl: ".tp-slider-button-next",
                prevEl: ".tp-slider-button-prev",
              },
              breakpoints: {
                0: {
                  spaceBetween: 10,
                  slidesPerView: "auto",
                },
                768: {
                  slidesPerView: "auto",
                  spaceBetween: 16,
                },
              },
            });
          }
        });
      </script>
		</div>
	{% endif %}

{% set hasPartner = false %}
  <section class="tp-brands pt-1 pb-4 rounded-edges brands-ctg">
    <div class="container">
        {% if main_title %}
        <div class="tp-title-section">
          <h3>{{ main_title }}</h3>
        </div>
        {% endif %}
      <div class="tp-brands-swiper">
        {% for partner in store_partners %}
          {% if partner.category.id == category.id %}
          {% set hasPartner = true %}
          <div class="swiper-slide">
            <div class="tp-brand-item">
              <div class="tp-brand-thumb">
                {% if partner.image %}
                <a href="{% if partner.url %}{{ partner.url }}{% else %}javascript:;{% endif %}"
                  aria-label="brand">
                  <img loading="lazy" width="125" height="125" class="lazy-img" src="{{ image_url(partner.image) }}"
                    alt="">
                </a>
                {% endif %}
              </div>
              <h3 class="tp-brand-title">
                <a href="{% if partner.url %}{{ partner.url }}{% else %}javascript:;{% endif %}">
                {{ partner.title }}
                </a>
              </h3>
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          var arrowNextClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_right' : 'icon-keyboard_arrow_left';
          var arrowPrevClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_left' : 'icon-keyboard_arrow_right';

          var $slider = $('.tp-brands-swiper');

          if ($slider.length && !$slider.hasClass('slick-initialized')) {
            $slider.slick({
              slidesToScroll: 1,
              slidesToShow: 9,
              infinite: true,
              autoplay: true,
              autoplaySpeed: 1000,
              pauseOnHover: true,
              arrows: false,
              dots: false,
              rtl: !(window.appDirection === 'ltr'),
              nextArrow: '<button class="slick-next slick-arrow" aria-label="Next" type="button"><span class="' + arrowNextClass + '"></span></button>',
              prevArrow: '<button class="slick-prev slick-arrow" aria-label="Previous" type="button"><span class="' + arrowPrevClass + '"></span></button>',
              responsive: [
                { breakpoint: 1200, settings: { slidesToShow: 8 } },
                { breakpoint: 1024, settings: { slidesToShow: 7 } },
                { breakpoint: 992, settings: { slidesToShow: 6 } },
                { breakpoint: 768, settings: { slidesToShow: 5 } },
                { breakpoint: 450, settings: { slidesToShow: 4 } },
                { breakpoint: 375, settings: { slidesToShow: 3 } },
              ]
            });
          }
        });

      </script>
  </section>

{% if not hasPartner %}
  <style>
    .tp-brands.brands-ctg { display: none; }
  </style>
{% endif %}

     <div class="container">
        <div class="products-filters-box">
            {% if  products.filters|length > 0 %}
              {% set async=true %} {% include 'vitrin:products/filters.jinja' %}
            {% endif %}
            <div class="products-container">
              <div>
                {% set count=products.count %}{% set has_products_filtration=(products.filters|length > 0) %}{% include 'components/products-filter.jinja' %}
            </div>
              <div id="products-list" class="products-grid">
                {% for product in products.results %}
                  {% set product=product %}{% set index=key %}{% include 'components/product-card.jinja' %}
                {% endfor %}
              </div>
            </div>
          </div>
    </div>

    {% if display_mode %}
    {% set totalPages=products.pages_count %}{% set currentPage=products.page %}{% include 'components/pagination.jinja' %}
      {% else %}
        {% if auto_load_more %}
          <button id="load-more-button" class="load-more-button" data-pages="{{ products.pages_count }}" type="button" disabled aria-hidden="true" style="pointer-events:none;">
            <span class="btn-loader">
                <span class="loader-more"></span>
            </span>
          </button>
        {% else %}
          <button id="load-more-button" class="load-more-button tp-btn" data-pages="{{ products.pages_count }}">
            <span class="btn-loader d-none">
                <span class="loader-more"></span>
            </span>
            <span class="btn-label">{{ _("Load more") }}</span>
          </button>
        {% endif %}
    {% endif %}

	<div class="container">
		{% set entity = category %}
    {% include 'vitrin:shared/metafields.jinja' %}
	</div>

{% endblock %}

{% block footer %}
	{% include 'footer.jinja' %}
{% endblock %}


{% block footer_scripts %}
<script type="text/javascript" src="{{ 'toastr.min.js' | asset_url }}"></script>
	<script>
		window.onProductAttributesTriggered = function () {
$('#products-list').css('opacity', '0.4');
$('#product-pagination').css('opacity', '0');

}

window.onProductAttributesChanged = function (htmlStr) {
var html = $.parseHTML(htmlStr);
$('#products-list').html($('#products-list', html).html());
$('#products-list').css('opacity', '1');
$('#product-filter-count').html($('#product-filter-count', html).html());
$('#product-filter-count').css('opacity', '1');
if ($('#product-pagination', html).length > 0) {
$('#product-pagination').html($('#product-pagination', html).html());
$('#product-pagination').css('opacity', '1');
}
}

{% if  products.data|length > 0 %}
        document.addEventListener("DOMContentLoaded", function(){
            var productsObj = {{ products.data | tojson }}
                window.sendGaProductsViewItemsListEvent('{{ category.name }}', productsObj);
        });
        {% endif %}
	</script>

{% if not display_mode %}
  <script type="text/javascript" src="{{ 'load-more.js' | asset_url }}"></script>
{% endif %}

<script>
window.addEventListener('DOMContentLoaded', (event) => {
    var fromPriceInput = document.querySelector("input[name='from_price'][type='hidden']");
    var toPriceInput = document.querySelector("input[name='to_price'][type='hidden']");

    if (fromPriceInput && toPriceInput) {
        var fromPrice = fromPriceInput.value;
        var toPrice = toPriceInput.value;

        var fromPriceField = document.querySelector(".attribute-price-body input[name='from_price']");
        var toPriceField = document.querySelector(".attribute-price-body input[name='to_price']");

        if (fromPriceField && toPriceField) {
            fromPriceField.value = fromPrice;
            toPriceField.value = toPrice;
        }
    }
});

function loadNoUiSlider(callback) {
    let link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css";
    document.head.appendChild(link);

    let script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js";
    script.onload = callback;
    document.body.appendChild(script);
}

loadNoUiSlider(() => {
    const priceContainer = document.querySelector(".attribute-price-body .form-row");

    if (!priceContainer) {
        return;
    }

    const sliderContainer = document.createElement("div");
    sliderContainer.id = "price-slider";

    priceContainer.insertAdjacentElement("afterend", sliderContainer);

    noUiSlider.create(sliderContainer, {
        start: [0, 15000],
        connect: true,
        direction: "{{ session.locale.language.direction }}",
        range: {
            min: 0,
            max: 15000,
        },
        step: 10,
    });

    const fromPriceInput = document.querySelector('.attribute-price-body input[name="from_price"]');
    const toPriceInput = document.querySelector('.attribute-price-body input[name="to_price"]');

    if (!fromPriceInput || !toPriceInput) {
        return;
    }

    sliderContainer.noUiSlider.on("update", (values) => {
        fromPriceInput.value = Math.round(values[0]);
        toPriceInput.value = Math.round(values[1]);
    });

    fromPriceInput.addEventListener("change", () => {
        const fromValue = parseFloat(fromPriceInput.value) || 0;
        const toValue = parseFloat(toPriceInput.value) || 5000;

        sliderContainer.noUiSlider.set([fromValue, toValue]);
    });

    toPriceInput.addEventListener("change", () => {
        const fromValue = parseFloat(fromPriceInput.value) || 0;
        const toValue = parseFloat(toPriceInput.value) || 5000;

        sliderContainer.noUiSlider.set([fromValue, toValue]);
    });
});

const attributeFooter = document.querySelector('.attribute-footer');

if (attributeFooter) {
    const clearText = '{{ _("Clear") }}';

    attributeFooter.insertAdjacentHTML(
        'beforeend',
        `<button id="products-list-filter-form-clear" type="button" class="tp-btn tp-btn-primary-outline" onclick="clearFilters()">
            <span>${clearText}</span>
        </button>`
    );
}

const filterButton = document.querySelector('.open-close-filter');
const productAttributes = document.querySelector('.product-attributes');
const overlayFilter = document.querySelector('.overlay-filter');
const filtrationHeader = document.querySelector('.filtration-header');

filterButton.addEventListener('click', () => {
    productAttributes.classList.toggle('hide-filter');

    if (window.innerWidth <= 1200) {
        overlayFilter.classList.toggle('active');

        if (filtrationHeader) {
            if (!filtrationHeader.querySelector('em')) {
                const emElement = document.createElement('em');
                filtrationHeader.appendChild(emElement);
                 emElement.addEventListener('click', () => {
                    productAttributes.classList.remove('hide-filter');
                    overlayFilter.classList.remove('active');
                });
            }
        }
    }
});

overlayFilter.addEventListener('click', () => {
    productAttributes.classList.remove('hide-filter');
    overlayFilter.classList.remove('active');
});

</script>


{% endblock %}


