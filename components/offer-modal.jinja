<!-- Offer Popups -->
<div id="offer-modals-container">
  {% for offer in offer_modals %}
    {% if offer.enabled %}
    <div class="popup-sec popup-main offer-modal"
         id="offer-modal-{{ loop.index }}"
         data-priority="{{ offer.priority }}"
         data-target-audience="{{ offer.targeting.target_audience }}"
         data-target-pages="
            {% if offer.targeting.target_pages_all %}all{% endif %}
            {% if offer.targeting.target_pages_home %}
              {% if offer.targeting.target_pages_all %},{% endif %}home
            {% endif %}
            {% if offer.targeting.target_pages_product %}
              {% if offer.targeting.target_pages_all or offer.targeting.target_pages_home %},{% endif %}product_details
            {% endif %}
            {% if offer.targeting.target_pages_category %}
              {% if offer.targeting.target_pages_all or offer.targeting.target_pages_home or offer.targeting.target_pages_product %},{% endif %}category_details
            {% endif %}
            {% if offer.targeting.target_pages_cart %}
              {% if offer.targeting.target_pages_all or offer.targeting.target_pages_home or offer.targeting.target_pages_product or offer.targeting.target_pages_category %},{% endif %}cart_page
            {% endif %}
            {% if offer.targeting.target_pages_blog %}
              {% if offer.targeting.target_pages_all or offer.targeting.target_pages_home or offer.targeting.target_pages_product or offer.targeting.target_pages_category or offer.targeting.target_pages_cart or offer.targeting.target_pages_checkout or offer.targeting.target_pages_account %},{% endif %}blogs
            {% endif %}
            {% if offer.targeting.target_pages_search %}
              {% if offer.targeting.target_pages_all or offer.targeting.target_pages_home or offer.targeting.target_pages_product or offer.targeting.target_pages_category or offer.targeting.target_pages_cart or offer.targeting.target_pages_checkout or offer.targeting.target_pages_account or offer.targeting.target_pages_blog %},{% endif %}search
            {% endif %}
            {% if offer.targeting.target_pages_page %}
              {% if offer.targeting.target_pages_all or offer.targeting.target_pages_home or offer.targeting.target_pages_product or offer.targeting.target_pages_category or offer.targeting.target_pages_cart or offer.targeting.target_pages_checkout or offer.targeting.target_pages_account or offer.targeting.target_pages_blog or offer.targeting.target_pages_search %},{% endif %}pages
            {% endif %}
         "
         data-delay="{{ offer.display_settings.delay_seconds }}"
         data-frequency="{{ offer.display_settings.show_frequency }}"
         data-offer-id="{{ loop.index }}"
         style="display: none;">

      <div class="popup-box">

        <!-- Close Button -->
        <button type="button" class="close-modal-custom offer-modal-close" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M2.14735 15.8521C2.19379 15.8986 2.24893 15.9354 2.30963 15.9606C2.37033 15.9858 2.43539 15.9987 2.5011 15.9987C2.56681 15.9987 2.63187 15.9858 2.69257 15.9606C2.75327 15.9354 2.80841 15.8986 2.85485 15.8521L8.99985 9.70708L15.1473 15.8521C15.2412 15.9459 15.3684 15.9986 15.5011 15.9986C15.6338 15.9986 15.761 15.9459 15.8548 15.8521C15.9487 15.7583 16.0014 15.631 16.0014 15.4983C16.0014 15.3656 15.9487 15.2384 15.8548 15.1446L9.70735 8.99957L15.8523 2.85207C15.9462 2.75825 15.9989 2.63101 15.9989 2.49832C15.9989 2.36564 15.9462 2.2384 15.8523 2.14457C15.7585 2.05075 15.6313 1.99805 15.4986 1.99805C15.3659 1.99805 15.2387 2.05075 15.1448 2.14457L8.99985 8.29208L2.85235 2.14707C2.7567 2.06516 2.63366 2.02236 2.50782 2.02722C2.38198 2.03208 2.26262 2.08425 2.17357 2.17329C2.08452 2.26234 2.03235 2.38171 2.02749 2.50755C2.02263 2.63339 2.06544 2.75642 2.14735 2.85207L8.29235 8.99957L2.14735 15.1471C2.05422 15.2408 2.00195 15.3675 2.00195 15.4996C2.00195 15.6317 2.05422 15.7584 2.14735 15.8521Z"
              fill="#2E2E2E"></path>
          </svg>
        </button>

        <!-- Popup Content -->
        <div class="popup-container">
          <a href="{{ offer.content.url|default('javascript:;') }}" class="img-popup">
            {% if offer.content.image %}
              <img src="{{ offer.content.image }}" alt="{{ offer.title }}">
            {% endif %}
          </a>
          <div class="content-popup">
            {% if offer.content.title %}
              <h3>{{ offer.content.title }}</h3>
            {% endif %}

            {% if offer.content.description %}
              <p>{{ offer.content.description | safe }}</p>
            {% endif %}
            {% if offer.content.btn_text %}
              <a href="{{ offer.content.url|default('javascript:;') }}"
                 class="offer-modal-btn offer-modal-btn-primary"
                 style="background: {{ offer.primary_cta_bg_color }};
                        color: {{ offer.primary_cta_text_color }};">
                {{ offer.content.btn_text }}
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    <!-- Overlay -->
    <div class="overlay-popup overlay-main offer-modal-backdrop"></div>
    </div>
    {% endif %}
  {% endfor %}
</div>


<script>
// Offer Modals Management System
(function() {
    'use strict';
    
    const OfferModals = {
        init: function() {
            this.isAuthenticated = this.checkAuthStatus();
            this.currentPage = this.getCurrentPage();
            this.sessionKey = 'offer_modals_shown';
            this.processOffers();
            this.bindEvents();
        },
        
        getCurrentPage: function() {
            // Get current page template from body data attribute
            const template = document.body.getAttribute('data-template') || 'unknown';
            return template;
        },
        
        checkAuthStatus: function() {
            if (window.customerAuthState && typeof window.customerAuthState.isAuthenticated !== 'undefined') {
                return window.customerAuthState.isAuthenticated === true;
            }

            return false;
        },
        
        processOffers: function() {
            const offers = document.querySelectorAll('.offer-modal');
            const eligibleOffers = [];
            
            offers.forEach(offer => {
                if (this.isOfferEligible(offer)) {
                    eligibleOffers.push({
                        element: offer,
                        priority: parseInt(offer.dataset.priority),
                        delay: parseInt(offer.dataset.delay) * 1000,
                        frequency: offer.dataset.frequency,
                        offerId: offer.dataset.offerId
                    });
                }
            });
            
            if (eligibleOffers.length > 0) {
                // Sort by priority (0 = highest priority)
                eligibleOffers.sort((a, b) => a.priority - b.priority);
                
                // Show the highest priority eligible offer
                const selectedOffer = eligibleOffers[0];
                this.showOffer(selectedOffer);
            }
        },
        
        isOfferEligible: function(offerElement) {
            // Check if review modal is being opened via URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('open_review') === 'true') {
                return false;
            }
            
            const targetAudience = offerElement.dataset.targetAudience;
            const targetPages = offerElement.dataset.targetPages;
            const frequency = offerElement.dataset.frequency;
            const offerId = offerElement.dataset.offerId;
            
            // Check authentication requirement
            if (targetAudience === 'authenticated' && !this.isAuthenticated) {
                return false;
            }
            
            if (targetAudience === 'non_authenticated' && this.isAuthenticated) {
                return false;
            }
            
            // Check page targeting requirement
            if (targetPages) {
                const pagesArray = targetPages.split(',').map(page => page.trim());
                if (!pagesArray.includes('all') && !pagesArray.includes(this.currentPage)) {
                    return false;
                }
            }
            
            // Check frequency requirement
            if (frequency === 'once_per_session') {
                const shownOffers = this.getSessionStorage('shown_offers') || [];
                if (shownOffers.includes(offerId)) {
                    return false;
                }
            }
            
            return true;
        },
        
        showOffer: function(offer) {
            setTimeout(() => {
                offer.element.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // إضافة class active على الـ overlay
                const overlay = offer.element.querySelector('.offer-modal-backdrop');
                if (overlay) {
                    overlay.classList.add('active');
                }
                
                // Mark as shown for session
                if (offer.frequency === 'once_per_session') {
                    const shownOffers = this.getSessionStorage('shown_offers') || [];
                    shownOffers.push(offer.offerId);
                    this.setSessionStorage('shown_offers', shownOffers);
                }
                
                // Analytics tracking (optional)
                this.trackOfferShown(offer.offerId);
                
            }, offer.delay);
        },
        
        hideOffer: function(offerElement) {
            offerElement.style.display = 'none';
            document.body.style.overflow = '';
            
            // إزالة class active من الـ overlay
            const overlay = offerElement.querySelector('.offer-modal-backdrop');
            if (overlay) {
                overlay.classList.remove('active');
            }
            
            // Track close event
            const offerId = offerElement.dataset.offerId;
            this.trackOfferClosed(offerId);
        },
        
        bindEvents: function() {
            // Close button clicks
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('offer-modal-close') || 
                    e.target.closest('.offer-modal-close')) {
                    const modal = e.target.closest('.offer-modal');
                    if (modal) {
                        this.hideOffer(modal);
                    }
                }
            });
            
            // Backdrop clicks
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('offer-modal-backdrop')) {
                    const modal = e.target.closest('.offer-modal');
                    if (modal) {
                        this.hideOffer(modal);
                    }
                }
            });
            
            // Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const visibleModal = document.querySelector('.offer-modal[style*="flex"]');
                    if (visibleModal) {
                        this.hideOffer(visibleModal);
                    }
                }
            });
            
            // Track CTA clicks
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('offer-modal-btn')) {
                    const modal = e.target.closest('.offer-modal');
                    if (modal) {
                        const offerId = modal.dataset.offerId;
                        const ctaType = e.target.classList.contains('offer-modal-btn-primary') ? 'primary' : 'secondary';
                        this.trackCTAClick(offerId, ctaType);
                    }
                }
            });
        },
        
        // Session storage helpers
        getSessionStorage: function(key) {
            try {
                const item = sessionStorage.getItem(this.sessionKey + '_' + key);
                return item ? JSON.parse(item) : null;
            } catch (e) {
                return null;
            }
        },
        
        setSessionStorage: function(key, value) {
            try {
                sessionStorage.setItem(this.sessionKey + '_' + key, JSON.stringify(value));
            } catch (e) {
                console.warn('Could not save to session storage');
            }
        },
        
        // Analytics tracking methods (can be customized)
        trackOfferShown: function(offerId) {
            // Custom tracking logic here
            
        },
        
        trackOfferClosed: function(offerId) {
            // Custom tracking logic here
            
        },
        
        trackCTAClick: function(offerId, ctaType) {
            // Custom tracking logic here
            
        }
    };
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => OfferModals.init());
    } else {
        OfferModals.init();
    }
    
    // Expose for external use if needed
    window.OfferModals = OfferModals;
})();
</script>
