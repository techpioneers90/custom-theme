{% if not settings.hide_element %}
<section class="tp-video-with-products s-block" section-id="{{ sectionId }}">
	<style>
		/* قبل ما slick يتهيأ، خفي الشرائح غير المرئية */
		[section-id="{{ sectionId }}"] .tp-products-box-swiper:not(.slick-initialized) .swiper-slide:not(:first-child) {
			display: none;
		}
	</style>
	
	<div class="container">
    <div class="tp-title-section none-lg">
      {% if settings.small_subtitle %}
        <span>{{ settings.small_subtitle }}</span>
      {% endif %}
      {% if settings.title %}
        <h3>{{ settings.title }}</h3>
      {% endif %}
    </div>
		<div class="video-products {% if settings.reverse_box %} reverse-box {% endif %}">
			<div class="video-box">
				{% if settings.video %}
					<video width="100%" loop autoplay muted playsinline preload="none" data-video-src="{{ settings.video }}">
						<source type="video/mp4" data-src="{{ settings.video }}">
						Your browser does not support the video tag.
					</video>
				{% endif %}
			</div>
			<div class="tp-products-part" >
				<div class="tp-title-section">
					{% if settings.small_subtitle %}
						<span>{{ settings.small_subtitle }}</span>
					{% endif %}
					{% if settings.title %}
						<h3>{{ settings.title }}</h3>
					{% endif %}
				</div>
				<div class="tp-products-box-swiper">
						{% if settings.products and settings.products.results %}
						{% for product in settings.products.results %}
							<div class="swiper-slide">
								{% set index=loop.index0 %}
                {% include 'components/product-card.jinja' %}
							</div>
						{% endfor %}
						{% endif %}
				</div>
			</div>
		</div>
	</div>
       <script>
  (function() {
    // تهيئة السلايدر فقط عندما يكون مرئياً
    function initSlider() {
      var arrowNextClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_right' : 'icon-keyboard_arrow_left';
      var arrowPrevClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_left' : 'icon-keyboard_arrow_right';

      var $slider = $('[section-id="{{ sectionId }}"] .tp-products-box-swiper');

      if ($slider.length && !$slider.hasClass('slick-initialized')) {
        $slider.slick({
          slidesToScroll: 4,
          slidesToShow: 4,
          infinite: false,
          autoplay: true,
          autoplaySpeed: 3000,
          arrows: true,
          dots: false,
          rtl: !(window.appDirection === 'ltr'),
          nextArrow: '<button class="slick-next slick-arrow" aria-label="Next" type="button"><span class="'+arrowNextClass+'"></span></button>',
          prevArrow: '<button class="slick-prev slick-arrow" aria-label="Previous" type="button"><span class="'+arrowPrevClass+'"></span></button>',
          responsive: [
            {
              breakpoint: 768,
              settings: {
                slidesToShow: 3,
                slidesToScroll: 3,
              }
            },
            {
              breakpoint: 450,
              settings: {
                slidesToShow: 2,
                slidesToScroll: 2,
              }
            },
            {
              breakpoint: 350,
              settings: {
                slidesToShow: 1,
                slidesToScroll: 1,
              }
            }
          ]
        });
      }
    }

    // استخدام IntersectionObserver لتهيئة السلايدر فقط عند ظهوره
    if ('IntersectionObserver' in window) {
      var section = document.querySelector('[section-id="{{ sectionId }}"]');
      if (section) {
        var observer = new IntersectionObserver(function(entries) {
          entries.forEach(function(entry) {
            if (entry.isIntersecting) {
              if (typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                initSlider();
                observer.unobserve(entry.target);
              } else {
                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', initSlider);
                } else {
                  initSlider();
                }
                observer.unobserve(entry.target);
              }
            }
          });
        }, {
          rootMargin: '300px'
        });
        
        observer.observe(section);
      }
    } else {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSlider);
      } else {
        initSlider();
      }
    }
  })();
</script>

  <script>
    // تحميل الفيديو فقط عند ظهوره
    (function() {
      if ('IntersectionObserver' in window) {
        var section = document.querySelector('[section-id="{{ sectionId }}"]');
        if (section) {
          var video = section.querySelector('video[data-video-src]');
          if (video) {
            var observer = new IntersectionObserver(function(entries) {
              entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                  var videoElement = entry.target;
                  var source = videoElement.querySelector('source[data-src]');
                  if (source && !source.src) {
                    source.src = source.getAttribute('data-src');
                    videoElement.load();
                    observer.unobserve(videoElement);
                  }
                }
              });
            }, {
              rootMargin: '300px'
            });
            
            observer.observe(video);
          }
        }
      } else {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            var video = document.querySelector('[section-id="{{ sectionId }}"] video[data-video-src]');
            if (video) {
              var source = video.querySelector('source[data-src]');
              if (source) {
                source.src = source.getAttribute('data-src');
                video.load();
              }
            }
          });
        }
      }
    })();
  </script>

</section>
{% endif %}




