{% if not settings.hide_element %}
<section
  class="tp-slider-spicial-section s-block {% if settings.slider_auto %} tp-slider-img-auto {% endif %} {% if settings.stop_animation %} stop-animation {% endif %}"
  section-id="{{ sectionId }}">
  
  <style>
    /* قبل ما slick يتهيأ، اعرض أول بانر فقط وخفي الباقي لتجنب تراص البنرات */
    [section-id="{{ sectionId }}"] .tp-slider-spicial:not(.slick-initialized) .swiper-slide:not(:first-child) {
      display: none;
    }
  </style>

  <div class="tp-slider-spicial" data-autoplay="{% if settings.autoplay %}true{% else %}false{% endif %}">
    {% if 'spicial_slider' in settings %}
    {% set spicial_slider = settings.spicial_slider %}
    {% if spicial_slider is callable %}
    {% set spicial_slider = spicial_slider() %}
    {% endif %}
    {% else %}
    {% set spicial_slider = [] %}
    {% endif %}
    {% if spicial_slider is not iterable %}
    {% set spicial_slider = [] %}
    {% endif %}

    {% for slide in spicial_slider %}
    <div class="swiper-slide">
      <a href="{% if slide.url %}{{ slide.url }}{% else %}javascript:;{% endif %}">
        {% if slide.video and slide.image %}
        <video width="100%" loop autoplay muted playsinline {% if loop.index0 > 0 %}preload="none"{% else %}preload="auto"{% endif %}>
          <source src="{{ slide.video }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        {% elif slide.image %}
        <picture>
          {% if slide.image_mobile %}
          <source media="(max-width: 767px)" srcset="{{ slide.image_mobile }}">
          {% endif %}
          <source media="(min-width: 768px)" srcset="{{ slide.image }}">
          <img 
            loading="{% if loop.index0 == 0 %}eager{% else %}lazy{% endif %}" 
            {% if loop.index0 == 0 %}fetchpriority="high"{% endif %}
            width="1600" 
            height="700" 
            class="lazy-img" 
            src="{{ slide.image }}" 
            alt="banner-desktop">
        </picture>
        {% elif slide.video %}
        <video width="100%" loop autoplay muted playsinline {% if loop.index0 > 0 %}preload="none"{% else %}preload="auto"{% endif %}>
          <source src="{{ slide.video }}" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        {% endif %}
        {% if slide.title or slide.sub_title or slide.btn_text %}
        <div class="box-text-info">
          {% if slide.title %}
          <h3 data-swiper-parallax="-500" style="color:{{slide.color}}">{{ slide.title }}</h3>
          {% endif %}
          {% if slide.sub_title %}
          <p data-swiper-parallax="-300">{{ slide.sub_title }}</p>
          {% endif %}
          {% if slide.btn_text %}
          <button data-swiper-parallax="-100" class="tp-btn tp-btn-white">
            {{ slide.btn_text }}
          </button>
          {% endif %}
        </div>
        {% endif %}
      </a>
    </div>
    {% endfor %}
  </div>

  <script>
    (function() {
      // تهيئة السلايدر فقط عندما يكون مرئياً (Lazy initialization)
      function initSlider() {
        var arrowNextClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_right' : 'icon-keyboard_arrow_left';
        var arrowPrevClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_left' : 'icon-keyboard_arrow_right';

        var $slider = $('[section-id="{{ sectionId }}"] .tp-slider-spicial');

        if ($slider.length && !$slider.hasClass('slick-initialized')) {
          var autoplayEnabled = $slider.attr("data-autoplay") === "true";

          $slider.slick({
            slidesToShow: 1,
            slidesToScroll: 1,
            infinite: true,
            autoplay: autoplayEnabled,
            autoplaySpeed: 7000,
            arrows: true,
            dots: true,
            speed: 500,
            fade: true,
            cssEase: 'linear',
            rtl: !(window.appDirection === 'ltr'),
            nextArrow: '<button class="slick-next slick-arrow" aria-label="Next" type="button"><span class="' + arrowNextClass + '"></span></button>',
            prevArrow: '<button class="slick-prev slick-arrow" aria-label="Previous" type="button"><span class="' + arrowPrevClass + '"></span></button>'
          });
        }
      }

      // استخدام IntersectionObserver لتهيئة السلايدر فقط عند ظهوره
      if ('IntersectionObserver' in window) {
        var section = document.querySelector('[section-id="{{ sectionId }}"]');
        if (section) {
          var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                // تأكد من تحميل jQuery و slick قبل التهيئة
                if (typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                  initSlider();
                  observer.unobserve(entry.target);
                } else {
                  // إذا لم يكن jQuery جاهزاً، استخدم DOMContentLoaded كبديل
                  if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initSlider);
                  } else {
                    initSlider();
                  }
                  observer.unobserve(entry.target);
                }
              }
            });
          }, {
            rootMargin: '300px'
          });
          
          observer.observe(section);
        }
      } else {
        // Fallback للمتصفحات القديمة
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initSlider);
        } else {
          initSlider();
        }
      }
    })();
  </script>

</section>
{% endif %}