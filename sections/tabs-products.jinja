{% if not settings.hide_element %}
<section class="tp-tabs-products s-block" section-id="{{ sectionId }}" style="background: {{ settings.background_color }};">
  <style>
    /* قبل ما slick يتهيأ، خفي الشرائح غير المرئية */
    [section-id="{{ sectionId }}"] .tp-products-swiper:not(.slick-initialized) .swiper-slide:not(:first-child) {
      display: none;
    }
  </style>
  
  <div class="container">
    <div class="tp-title-section">
      {% if settings.small_subtitle %}
        <span style="color: {{ settings.text_color }};">{{ settings.small_subtitle }}</span>
      {% endif %}
      {% if settings.title %}
        <h3 style="color: {{ settings.text_color }};" >{{ settings.title }}</h3>
      {% endif %}
      {% if settings.small_text %}
        <p style="color: {{ settings.text_color }};" >{{ settings.small_text }}</p>
      {% endif %}
    </div>

{% set items_xl = (settings.items_xl|default(6))|int %}
{% set items_lg = (settings.items_lg|default(5))|int %}
{% set items_md = (settings.items_md|default(4))|int %}
{% set items_sm = (settings.items_sm|default(2))|int %}
{% set items_xs = (settings.items_xs|default(1))|int %}
{% if items_xl < 1 %}{% set items_xl = 1 %}{% endif %}
{% if items_lg < 1 %}{% set items_lg = 1 %}{% endif %}
{% if items_md < 1 %}{% set items_md = 1 %}{% endif %}
{% if items_sm < 1 %}{% set items_sm = 1 %}{% endif %}
{% if items_xs < 1 %}{% set items_xs = 1 %}{% endif %}

{% set limit = (settings.product_limit|default(6)|int) %}
{% if limit < 1 %}{% set limit = 6 %}{% endif %}

    <div class="tp-tabs">
      <ul class="tp-tabs-list" style="color: {{ settings.text_color }};">
        {% if settings.tabs %}
          {% for tab in settings.tabs %}
            <li class="tp-tab-item {% if loop.first %}active{% endif %}" data-tab="tab-{{ sectionId }}-{{ loop.index }}">
              {{ tab.label }}
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </div>

    <div class="tp-tabs-content">
      {% if settings.tabs %}
        {% for tab in settings.tabs %}
          <div class="tp-tab-content {% if loop.first %}active{% endif %}" data-tab-content="tab-{{ sectionId }}-{{ loop.index }}" 
               {% if tab.category and tab.category.id %}data-category-id="{{ tab.category.id }}"{% endif %}>
            <div class="tp-products-swiper">
              {% if tab.category and tab.category.results %}
                {% for product in tab.category.results[:limit] %}
                  <div class="swiper-slide">
                    {% set index=loop.index0 %}
                    {% include 'components/product-card.jinja' %}
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            {% if tab.category and tab.category.url %}
              <a style="color: {{ settings.text_color }};" class="href" href="{{ tab.category.url }}">
              {{ _('View all') }}
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <g fill="none" class="stroke-current" stroke-width="1.5" stroke-linejoin="round" stroke-miterlimit="10">
                <circle class="arrow-icon--circle" cx="16" cy="16" r="15.12"></circle>
                <path class="arrow-icon--arrow" d="M16.14 9.93L22.21 16l-6.07 6.07M8.23 16h13.98"></path>
              </g>
            </svg>
          </a>
            {% endif %}
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

<script>
(function() {
    const arrowNextClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_right' : 'icon-keyboard_arrow_left';
    const arrowPrevClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_left' : 'icon-keyboard_arrow_right';
    const sectionId = "{{ sectionId }}";
    const limit = {{ limit }};

    // دالة لجلب المنتجات من API
    async function loadTabProducts(tabContent) {
        const slider = tabContent.querySelector('.tp-products-swiper');
        if (!slider) return;

        // إذا كان هناك منتجات موجودة بالفعل (من الصفحة الرئيسية)، لا نحتاج لجلبها
        // نتحقق من وجود swiper-slide يحتوي على product-box
        const existingProducts = slider.querySelectorAll('.swiper-slide .product-box, .product-box');
        if (existingProducts.length > 0) {
            return; // المنتجات موجودة بالفعل، لا حاجة لجلبها من API
        }

        const categoryId = tabContent.getAttribute('data-category-id');
        if (!categoryId || !window.zid || !window.zid.products || !window.zid.products.list) {
            return;
        }

        // عرض حالة التحميل
        slider.innerHTML = '<div class="loading-products">جاري التحميل...</div>';

        try {
            const response = await window.zid.products.list({
                categories: categoryId,
                page_size: limit
            }, { showErrorNotification: true });

            if (response && response.results && response.results.length > 0) {
                slider.innerHTML = '';
                
                // استخدام createProductCard من load-more.js إذا كان متاحاً
                // نتحقق من window.createProductCard أولاً، وإذا لم تكن متاحة ننتظر قليلاً
                let createCard = window.createProductCard;
                
                // إذا لم تكن متاحة، ننتظر قليلاً (قد يكون load-more.js لم يتم تحميله بعد)
                if (!createCard && typeof createProductCard !== 'undefined') {
                    createCard = createProductCard;
                }
                
                // إذا لم تكن متاحة بعد، ننتظر حتى 2 ثانية
                if (!createCard) {
                    let attempts = 0;
                    while (!createCard && attempts < 20) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        createCard = window.createProductCard || (typeof createProductCard !== 'undefined' ? createProductCard : null);
                        attempts++;
                    }
                }
                
                if (typeof createCard === 'function') {
                    for (const product of response.results) {
                        // createProductCard ترجع عنصر DOM، ليس HTML string
                        const productElement = await createCard(product);
                        if (productElement) {
                            const slideDiv = document.createElement('div');
                            slideDiv.className = 'swiper-slide';
                            slideDiv.appendChild(productElement);
                            slider.appendChild(slideDiv);
                        }
                    }
                    
                    // تفعيل العداد التنازلي والتحقق من الأسعار بعد إضافة جميع المنتجات
                    if (typeof initializeCountdowns === 'function') {
                        initializeCountdowns(slider);
                    }
                    
                    if (typeof formatPrices === 'function') {
                        formatPrices(slider);
                    }
                } else {
                    // إذا لم تكن createProductCard متاحة، نستخدم طريقة بديلة
                    console.warn('createProductCard function not found, using fallback method');
                    for (const product of response.results) {
                        const slideDiv = document.createElement('div');
                        slideDiv.className = 'swiper-slide';
                        slideDiv.innerHTML = `
                            <div class="product-box">
                                <a href="${product.html_url || '#'}">
                                    <div class="box-img-product">
                                        <img src="${product.images && product.images.length ? product.images[0].image.large : ''}" alt="${product.name}">
                                    </div>
                                    <h3>${product.name}</h3>
                                    <div class="price">${product.price_string || ''}</div>
                                </a>
                            </div>
                        `;
                        slider.appendChild(slideDiv);
                    }
                }

                // تهيئة الـ slider بعد تحميل المنتجات
                if (typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                    initSlickSlider(slider);
                }
            } else {
                slider.innerHTML = '<div class="no-products">لا توجد منتجات</div>';
            }
        } catch (error) {
            console.error('Error loading tab products:', error);
            slider.innerHTML = '<div class="error-loading">حدث خطأ أثناء تحميل المنتجات</div>';
        }
    }

    function initSlickSlider(slider) {
        if (!slider || slider.querySelectorAll('.product-box').length === 0) return;

        if ($(slider).hasClass("slick-initialized")) {
            $(slider).slick("unslick");
        }

        setTimeout(() => {
            if (!slider || slider.querySelectorAll('.product-box').length === 0) return;

            $(slider).slick({
                slidesToShow: {{ items_xl }},
                slidesToScroll: {{ items_xl }},
                infinite: true,
                autoplay: {{ 'true' if settings.autoplay_enabled else 'false' }},
                autoplaySpeed: 3000,
                arrows: true,
                dots: false,
                rtl: !(window.appDirection === 'ltr'),
                nextArrow: `<button class="slick-next slick-arrow" aria-label="Next" type="button"><span class="${arrowNextClass}"></span></button>`,
                prevArrow: `<button class="slick-prev slick-arrow" aria-label="Previous" type="button"><span class="${arrowPrevClass}"></span></button>`,
                responsive: [
                {
                  breakpoint: 1200,
                  settings: {
                    slidesToShow: {{ items_lg }},
                    slidesToScroll: {{ items_lg }}
                  }
                },
                {
                  breakpoint: 1024,
                  settings: {
                    slidesToShow: {{ items_md }},
                    slidesToScroll: {{ items_md }}
                  }
                },
                {
                  breakpoint: 768,
                  settings: {
                    slidesToShow: {{ items_sm }},
                    slidesToScroll: {{ items_sm }}
                  }
                },
                {
                  breakpoint: 450,
                  settings: {
                    slidesToShow: {{ items_xs }},
                    slidesToScroll: {{ items_xs }}
                  }
                },
                {
                  breakpoint: 350,
                  settings: {
                    slidesToShow: 1,
                    slidesToScroll: 1
                  }
                }
              ]
            });
        }, 300);
    }

    function initTabs() {
        const section = document.querySelector('[section-id="' + sectionId + '"]');
        if (!section) return;

        const tabs = section.querySelectorAll(".tp-tab-item");
        const tabContents = section.querySelectorAll(".tp-tab-content");

        // تحميل منتجات التبويب الأول إذا كان نشطاً
        const firstTabContent = section.querySelector(".tp-tab-content.active");
        if (firstTabContent) {
            const firstSlider = firstTabContent.querySelector(".tp-products-swiper");
            if (firstSlider && firstSlider.querySelectorAll('.product-box').length === 0) {
                loadTabProducts(firstTabContent).then(() => {
                    if (typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                        initSlickSlider(firstSlider);
                    }
                });
            } else if (firstSlider && typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                initSlickSlider(firstSlider);
            }
        }

        tabs.forEach(tab => {
            tab.addEventListener("click", function () {
                const target = this.getAttribute("data-tab");

                tabs.forEach(t => t.classList.remove("active"));
                tabContents.forEach(content => content.classList.remove("active"));

                this.classList.add("active");
                const targetContent = section.querySelector(`[data-tab-content="${target}"]`);
                if (targetContent) {
                    targetContent.classList.add("active");

                    const slider = targetContent.querySelector(".tp-products-swiper");
                    // تحميل المنتجات إذا لم تكن موجودة
                    if (slider && slider.querySelectorAll('.product-box').length === 0) {
                        loadTabProducts(targetContent).then(() => {
                            if (typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                                initSlickSlider(slider);
                            }
                        });
                    } else if (slider && typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                        initSlickSlider(slider);
                    }
                }
            });
        });
    }

    // استخدام IntersectionObserver لتهيئة التبويبات فقط عند ظهورها
    if ('IntersectionObserver' in window) {
        const section = document.querySelector('[section-id="{{ sectionId }}"]');
        if (section) {
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        if (typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                            initTabs();
                            observer.unobserve(entry.target);
                        } else {
                            if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', initTabs);
                            } else {
                                initTabs();
                            }
                            observer.unobserve(entry.target);
                        }
                    }
                });
            }, {
                rootMargin: '300px'
            });
            
            observer.observe(section);
        }
    } else {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTabs);
        } else {
            initTabs();
        }
    }
})();
</script>
</section>
{% endif %}



