{% if not settings.hide_element %}
<section class="tp-tabs-products s-block" section-id="{{ sectionId }}" style="background: {{ settings.background_color }};">
  <style>
    /* قبل ما slick يتهيأ، خفي الشرائح غير المرئية */
    [section-id="{{ sectionId }}"] .tp-products-swiper:not(.slick-initialized) .swiper-slide:not(:first-child) {
      display: none;
    }
  </style>
  
  <div class="container">
    <div class="tp-title-section">
      {% if settings.small_subtitle %}
        <span style="color: {{ settings.text_color }};">{{ settings.small_subtitle }}</span>
      {% endif %}
      {% if settings.title %}
        <h3 style="color: {{ settings.text_color }};" >{{ settings.title }}</h3>
      {% endif %}
      {% if settings.small_text %}
        <p style="color: {{ settings.text_color }};" >{{ settings.small_text }}</p>
      {% endif %}
    </div>

{% set items_xl = (settings.items_xl|default(6))|int %}
{% set items_lg = (settings.items_lg|default(5))|int %}
{% set items_md = (settings.items_md|default(4))|int %}
{% set items_sm = (settings.items_sm|default(2))|int %}
{% set items_xs = (settings.items_xs|default(1))|int %}
{% if items_xl < 1 %}{% set items_xl = 1 %}{% endif %}
{% if items_lg < 1 %}{% set items_lg = 1 %}{% endif %}
{% if items_md < 1 %}{% set items_md = 1 %}{% endif %}
{% if items_sm < 1 %}{% set items_sm = 1 %}{% endif %}
{% if items_xs < 1 %}{% set items_xs = 1 %}{% endif %}

{% set limit = (settings.product_limit|default(6)|int) %}
{% if limit < 1 %}{% set limit = 6 %}{% endif %}

    <div class="tp-tabs">
      <ul class="tp-tabs-list" style="color: {{ settings.text_color }};">
        {% if settings.tabs %}
          {% for tab in settings.tabs %}
            <li class="tp-tab-item {% if loop.first %}active{% endif %}" data-tab="tab-{{ sectionId }}-{{ loop.index }}">
              {{ tab.label }}
            </li>
          {% endfor %}
        {% endif %}
      </ul>
    </div>

    <div class="tp-tabs-content">
      {% if settings.tabs %}
        {% for tab in settings.tabs %}
          <div class="tp-tab-content {% if loop.first %}active{% endif %}" data-tab-content="tab-{{ sectionId }}-{{ loop.index }}">
            <div class="tp-products-swiper">
              {% if tab.category and tab.category.results %}
                {% for product in tab.category.results[:limit] %}
                  <div class="swiper-slide">
                    {% set index=loop.index0 %}
                    {% include 'components/product-card.jinja' %}
                  </div>
                {% endfor %}
              {% endif %}
            </div>
            {% if tab.category and tab.category.url %}
              <a style="color: {{ settings.text_color }};" class="href" href="{{ tab.category.url }}">
              {{ _('View all') }}
            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
              <g fill="none" class="stroke-current" stroke-width="1.5" stroke-linejoin="round" stroke-miterlimit="10">
                <circle class="arrow-icon--circle" cx="16" cy="16" r="15.12"></circle>
                <path class="arrow-icon--arrow" d="M16.14 9.93L22.21 16l-6.07 6.07M8.23 16h13.98"></path>
              </g>
            </svg>
          </a>
            {% endif %}
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>

<script>
(function() {
    const arrowNextClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_right' : 'icon-keyboard_arrow_left';
    const arrowPrevClass = (window.appDirection === 'ltr') ? 'icon-keyboard_arrow_left' : 'icon-keyboard_arrow_right';

    function initSlickSlider(slider) {
        if (!slider || slider.querySelectorAll('.product-box').length === 0) return;

        if ($(slider).hasClass("slick-initialized")) {
            $(slider).slick("unslick");
        }

        setTimeout(() => {
            if (!slider || slider.querySelectorAll('.product-box').length === 0) return;

            $(slider).slick({
                slidesToShow: {{ items_xl }},
                slidesToScroll: {{ items_xl }},
                infinite: true,
                autoplay: {{ 'true' if settings.autoplay_enabled else 'false' }},
                autoplaySpeed: 3000,
                arrows: true,
                dots: false,
                rtl: !(window.appDirection === 'ltr'),
                nextArrow: `<button class="slick-next slick-arrow" aria-label="Next" type="button"><span class="${arrowNextClass}"></span></button>`,
                prevArrow: `<button class="slick-prev slick-arrow" aria-label="Previous" type="button"><span class="${arrowPrevClass}"></span></button>`,
                responsive: [
                {
                  breakpoint: 1200,
                  settings: {
                    slidesToShow: {{ items_lg }},
                    slidesToScroll: {{ items_lg }}
                  }
                },
                {
                  breakpoint: 1024,
                  settings: {
                    slidesToShow: {{ items_md }},
                    slidesToScroll: {{ items_md }}
                  }
                },
                {
                  breakpoint: 768,
                  settings: {
                    slidesToShow: {{ items_sm }},
                    slidesToScroll: {{ items_sm }}
                  }
                },
                {
                  breakpoint: 450,
                  settings: {
                    slidesToShow: {{ items_xs }},
                    slidesToScroll: {{ items_xs }}
                  }
                },
                {
                  breakpoint: 350,
                  settings: {
                    slidesToShow: 1,
                    slidesToScroll: 1
                  }
                }
              ]
            });
        }, 300);
    }

    function initTabs() {
        const section = document.querySelector('[section-id="{{ sectionId }}"]');
        if (!section) return;

        const tabs = section.querySelectorAll(".tp-tab-item");
        const tabContents = section.querySelectorAll(".tp-tab-content");

        const firstSlider = section.querySelector(".tp-tab-content.active .tp-products-swiper");
        if (firstSlider && typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
            initSlickSlider(firstSlider);
        }

        tabs.forEach(tab => {
            tab.addEventListener("click", function () {
                const target = this.getAttribute("data-tab");

                tabs.forEach(t => t.classList.remove("active"));
                tabContents.forEach(content => content.classList.remove("active"));

                this.classList.add("active");
                const targetContent = section.querySelector(`[data-tab-content="${target}"]`);
                if (targetContent) {
                    targetContent.classList.add("active");

                    const slider = targetContent.querySelector(".tp-products-swiper");
                    if (slider && typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                        initSlickSlider(slider);
                    }
                }
            });
        });
    }

    // استخدام IntersectionObserver لتهيئة التبويبات فقط عند ظهورها
    if ('IntersectionObserver' in window) {
        const section = document.querySelector('[section-id="{{ sectionId }}"]');
        if (section) {
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        if (typeof $ !== 'undefined' && typeof $.fn.slick !== 'undefined') {
                            initTabs();
                            observer.unobserve(entry.target);
                        } else {
                            if (document.readyState === 'loading') {
                                document.addEventListener('DOMContentLoaded', initTabs);
                            } else {
                                initTabs();
                            }
                            observer.unobserve(entry.target);
                        }
                    }
                });
            }, {
                rootMargin: '300px'
            });
            
            observer.observe(section);
        }
    } else {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTabs);
        } else {
            initTabs();
        }
    }
})();
</script>
</section>
{% endif %}



